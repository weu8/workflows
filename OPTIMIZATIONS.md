# 潜在的工作流优化

本文档记录在审阅仓库中的可复用工作流时发现的后续改进思路，重点关注稳健性、可维护性与性能。

## `.github/workflows/cnb-ai-merge.yml`

- **复用默认环境配置。** 多个步骤重复设置 `set -e` 以及 Git 配置。可以抽取为复合动作或使用作业级 `env` 变量，减少重复并降低未来调整时的出错概率。
- **新增重试与退避辅助脚本。** 目前部分网络操作已有重试逻辑。为 fetch 和 push 命令封装带指数退避与日志的脚本，可让行为更一致、便于调优。
- **保护快照标签的一致性。** 当合并成功后标签推送失败，流程仍会继续。为标签步骤添加 `set -euo pipefail` 或显式校验，可避免 Git 状态与预期快照悄然偏离。

## `.github/workflows/cnb-sync.yml`

- **引入并发控制。** 同一分叉若同时执行多次同步作业，会导致推送冲突。可通过声明 `concurrency`（按仓库与分支生成 key）来安全串行化运行。
- **加强创建 PR 的错误处理。** 该步骤仅在无法快进时运行，但未对辅助动作失败进行防护。捕获输出并新增兜底通知步骤，可提升可观测性。
- **参数化上游分支。** 流程目前假设使用 `upstream/main`。将上游分支暴露为可选输入，有助于跟踪其他默认分支的分叉。

## `.github/workflows/cnb-all.yml`

- **补充调用方式示例。** 在仓库 README 中提供推荐的薄封装触发方式（如定时、手动调度或分支触发）示例，便于使用者快速配置自动化。
- **增加集成测试。** 可考虑新增一个 CI 作业，通过 `act`（或 `actionlint` 等工具）对可复用工作流进行检查，在发布前发现 YAML 或逻辑回归。

## 跨工作流建议

- **统一 GitHub Token 处理。** 所有工作流都会进行类似的 URL 重写以嵌入 `CNB_GH_TOKEN`。通过复合动作或 Shell 辅助脚本可确保转义一致，并简化令牌轮换。
- **遵循 Shell 最佳实践。** 多数 Shell 片段可加入 `set -euo pipefail` 与更严格的引用，以降低出现细微运行时缺陷的可能性。
